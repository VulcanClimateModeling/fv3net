storage_proto: gs
storage_root: vcm-ml-data/test-brianh
experiment:
  name: one-step-run-all-physics-off-small
  unique_id: True
  steps_to_run:
#     - coarsen_restarts
#     - coarsen_diagnostics
#     - one_step_run
    - one_step_diags
#     - create_training_data
#     - train_sklearn_model
#     - test_sklearn_model
#     - prognostic_run
#     - diags_prognostic_run
  
  steps_config:
    coarsen_restarts:
      command: python -m fv3net.pipelines.coarsen_restarts
      args:
        data_to_coarsen:
#           location: gs://vcm-ml-data/2019-12-02-40-day-X-SHiELD-simulation-C384-restart-files
          location: gs://vcm-ml-data/orchestration-testing/shield-C384-restarts-2019-12-04
        grid_spec: 
          location: gs://vcm-ml-data/2020-01-06-C384-grid-spec-with-area-dx-dy
        source-resolution: 384
        target-resolution: 48
        --runner: DataflowRunner
    
    coarsen_diagnostics:
      command: python ./workflows/coarsen_c384_diagnostics/coarsen_c384_diagnostics.py
      args:
        c384_diagnostics: 
          location: gs://vcm-ml-data/2019-12-05-40-day-X-SHiELD-simulation-C384-diagnostics/gfsphysics_15min_coarse.zarr
        coarsening_config: workflows/coarsen_c384_diagnostics/coarsen-c384-diagnostics.yml
    
    one_step_run:
      command: python workflows/one_step_jobs/orchestrate_submit_jobs.py
      args:
        restart_data:
          location: gs://vcm-ml-data/2020-01-16-X-SHiELD-2019-12-02-pressure-coarsened-rundirs/restarts/C48
#           from: coarsen_restarts
        experiment_yaml: ./workflows/one_step_jobs/all-physics-off.yml
#         docker_image: us.gcr.io/vcm-ml/prognostic_run:v0.1.0-a1
        docker_image: us.gcr.io/vcm-ml/prognostic_run:60795240f4d2147132df44fca48fdbfe17440116
#         docker_image: us.gcr.io/vcm-ml/fv3gfs-python:v0.3.1
#         docker_image: us.gcr.io/vcm-ml/prognostic_run:latest
        --config-version: v0.3
        --i-start: 96
        --n-steps: 96
        
    one_step_diags:
      command: python -m fv3net.diagnostics.one_step_jobs
      args:
        one_step_data:
#           from: one_step_run
          location: gs://vcm-ml-data/test-brianh/one-step-run-6883295e/one_step_run_ #all physics off
#           location: gs://vcm-ml-data/test-brianh/one-step-run-e2e68ff3/one_step_run_ # all physics on
#           location: /home/brianh/dev/fv3net/data/
#           location: gs://vcm-ml-data/test-brianh/one-step-run-883930c6/one_step_run_experiment_yaml_all-physics-off.yml_docker_image_prognostic_run:v0.1.0-a1_config-version_v0.3
        hi_res_diags:
          location: gs://vcm-ml-data/orchestration-testing/shield-coarsened-diags-2019-12-04
#           location: /home/brianh/dev/fv3net/data/
#         output_location: /home/brianh/dev/fv3net/data/all-physics-off-small-data
        --report_directory: gs://vcm-ml-public/test-brianh/one-step-diagnostics/all-physics-off
#         --report_directory: /home/brianh/dev/fv3net/data/all-physics-off-small-report
        --start_ind: 0
        --n_sample_inits: 2
        --runner: DirectRunner

    create_training_data:
      command: python -m fv3net.pipelines.create_training_data
      args:
        one_step_data:
          from: one_step_run
        diagnostics_data:
          location: gs://vcm-ml-data/orchestration-testing/shield-coarsened-diags-2019-12-04
        --train-fraction: 0.5
        --runner: DataflowRunner
        
    train_sklearn_model:
      command: python -m fv3net.regression.sklearn.train
      args:
        training_data:
          from: create_training_data
        train-config-file: ./workflows/sklearn_regression/example_base_rf_training_config.yml
        
    test_sklearn_model: 
      command: python -m fv3net.diagnostics.sklearn_model_performance
      args:
        trained_model:
          from: train_sklearn_model
        testing_data:
          from: create_training_data
        diagnostics_data:
          location: gs://vcm-ml-data/orchestration-testing/shield-coarsened-diags-2019-12-04
        --num_test_zarrs: 4

    prognostic_run:
      command: python workflows/prognostic_c48_run/orchestrate_submit_job.py
      args:
        restart_file_dir:
          from: one_step_run 
        ic_timestep: "20160801.001500"
        docker_image: us.gcr.io/vcm-ml/prognostic_run:v0.1.0
        --model_url:
          from: train_sklearn_model
        --prog_config_yml: workflows/prognostic_c48_run/prognostic_config.yml


    diags_prognostic_run:
      command: bash workflows/prognostic_run_diags/run_all.sh
      args:
        fv3_output:
          from: prognostic_run
