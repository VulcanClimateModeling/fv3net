user: brianh
storage_proto: gs
storage_root: vcm-ml-data/orchestration-testing
experiment:
  name: test-experiment
  unique_id: True
  fv3net_hash: ca279cb79c0b97a5e5e758ec8785612b3c7ec044
  workflow_steps: 
    - coarsen_restarts
    - coarsen_diagnostics
    - one_step_run
    - create_training_data
    - train_sklearn_model
    - test_sklearn_model
    - prognostic_run
  experiment_vars:
    one_step_yaml: ./workflows/one_step_jobs/all-physics-off.yml
  steps:
    coarsen_restarts:
      command: ./workflows/coarsen_restarts/orchestrator_job.sh
      inputs:
        data_to_coarsen:
          location: gs://vcm-ml-data/orchestration-testing/shield-C384-restarts-2019-12-04
      method:
        grid-spec: gs://vcm-ml-data/2020-01-06-C384-grid-spec-with-area-dx-dy
        source-resolution: 384
        target-resolution: 48
    
    coarsen_diagnostics:
      command: python ./workflows/coarsen_c384_diagnostics/coarsen_c384_diagnostics.py
      inputs:
        c384_diagnostics: 
          location: gs://vcm-ml-data/2019-12-05-40-day-X-SHiELD-simulation-C384-diagnostics/gfsphysics_15min_coarse.zarr
      method:
        coarsening_config: workflows/coarsen_c384_diagnostics/coarsen-c384-diagnostics.yml
    
    one_step_run:
      command: python ./workflows/one_step_jobs/orchestrate_submit_jobs.py
      inputs:
        restart_data:
          from: coarsen_restarts
      method: 
        experiment_yaml: one_step_yaml
        experiment_label: test-orchestration-group
      config_transforms:
        add_unique_id: 
          - experiment_label
        use_top_level:
          - experiment_yaml
    
    create_training_data:
      command: ./workflows/create_training_data/orchestrator_job_directrunner_test.sh
      inputs:
        one_step_data:
          from: one_step_run
#           location: gs://vcm-ml-data/orchestration-testing/test-experiment-e1b4376b/one_step_run_experiment_yaml_all-physics-off.yml_experiment_label_test-orchestration-group-e1b4376b
        diagnostics_data:
          from: coarsen_diagnostics
#           location: gs://vcm-ml-data/orchestration-testing/test-experiment-e1b4376b/coarsen_diagnostics_coarsening_config_coarsen-c384-diagnostics.yml/gfsphysics_15min_coarse.zarr
      method: 
        timesteps-per-output-file: 2
        mask-to-surface-type: 
        train-fraction: 0.5
        
    train_sklearn_model:
      command: ./workflows/sklearn_regression/orchestrator_train_sklearn.sh
      inputs:
        training_data:
          from: create_training_data
      method: 
        train-config-file: ./workflows/sklearn_regression/example_rf_training_config.yml
        
    test_sklearn_model: 
      command: ./workflows/sklearn_regression/orchestrator_test_sklearn.sh
      inputs:
        trained_model:
          from: train_sklearn_model
        testing_data:
          from: create_training_data
        diagnostics_data:
          from: coarsen_diagnostics
      method: 
        num-test-zarrs: 4
    
    prognostic_run:
      command: python workflows/prognostic_c48_run/orchestrate_submit_job.py
      inputs:
        sklearn_model:
          from: train_sklearn_model
          # location: gs://vcm-ml-data/test-annak/ml-pipeline-output/2020-01-17_rf_40d_run.pkl
        restart_file_dir:
          from: one_step_run
      method:
        prognostic_yaml_adjust: workflows/prognostic_c48_run/prognostic_config.yml
        ic_timestep: "20160801.001500"
        docker_image: "us.gcr.io/vcm-ml/prognostic-run-orchestration"