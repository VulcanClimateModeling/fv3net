apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: prognostic-run-diags
spec:
  arguments:
    parameters:
    - name: runs
    - name: docker-image
      value: us.gcr.io/vcm-ml/fv3net:839e86df984bc8b9d482d3f68e786c4fdc9baca3
    - name: make-movies
      value: "false"
    - name: flags
      value: " "
  entrypoint: all
  volumes:
  - name: gcp-key-secret
    secret:
      secretName: gcp-key
  templates:
  - name: all
    dag:
      tasks:
      - name: diagnostics-step
        withParam: "{{workflow.parameters.runs}}"
        template: diagnostics
        arguments:
          parameters:
            - name: run
              value: "{{item.url}}"
            - name: output
              value: "gs://vcm-ml-public/argo/{{workflow.name}}/{{item.name}}"
            - name: flags
              value: "{{workflow.parameters.flags}}"
      - name: movie-step
        when: "{{workflow.parameters.make-movies}} == true"
        withParam: "{{workflow.parameters.runs}}"
        template: movie
        continueOn:
          failed: true
        arguments:
          parameters:
            - name: run
              value: "{{item.url}}"
            - name: output
              value: "gs://vcm-ml-public/argo/{{workflow.name}}/{{item.name}}"
      - name: generate-report
        template: report
        dependencies: [diagnostics-step, movie-step]
  - name: report
    tolerations:
    - key: "dedicated"
      operator: "Equal"
      value: "climate-sim-pool"
      effect: "NoSchedule"
    container:
      image: '{{workflow.parameters.docker-image}}'
      command:
      - python
      - generate_report.py
      - gs://vcm-ml-public/argo/{{workflow.name}}
      - gs://vcm-ml-public/argo/{{workflow.name}}/index.html
      workingDir: /home/jovyan/fv3net/workflows/prognostic_run_diags
      env:
      - name: GOOGLE_APPLICATION_CREDENTIALS 
        value: /secret/gcp-credentials/key.json
      - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
        value: /secret/gcp-credentials/key.json
      volumeMounts:
      - mountPath: /secret/gcp-credentials
        name: gcp-key-secret
      resources:
        requests:
            memory: "6Gi"
            cpu: "1000m"
        limits:
            memory: "6Gi"
            cpu: "1000m"
  - name: diagnostics
    inputs:
      parameters:
      - name: run
      - name: output
      - name: image
        value: '{{workflow.parameters.docker-image}}'
      - name: flags
        value: " "
    steps:
      - - name: check-diags-cache
          template: check-diags-cache
          arguments:
            parameters:
              - {name: run, value: "{{inputs.parameters.run}}"}
              - {name: image, value: "{{inputs.parameters.image}}"}
      - - name: compute-diags
          template: compute-diags
          when: "{{steps.check-diags-cache.outputs.parameters.diags-in-cache}} == false"
          arguments:
            parameters:
              - {name: run, value: "{{inputs.parameters.run}}"}
              - {name: memoize-key, value: "{{steps.check-diags-cache.outputs.parameters.key}}"}
              - {name: image, value: "{{inputs.parameters.image}}"}
              - {name: flags, value: "{{inputs.parameters.flags}}"}
      - - name: copy-diags-to-output
          template: copy-diags-to-output
          arguments:
            parameters:
              - {name: memoize-key, value: "{{steps.check-diags-cache.outputs.parameters.key}}"}
              - {name: image, value: "{{inputs.parameters.image}}"}
              - {name: output, value: "{{inputs.parameters.output}}"}
  - name: check-diags-cache
    inputs:
      parameters:
        - name: run
        - name: image
    outputs:
      parameters:
        - name: key
          valueFrom:
            path: /tmp/memoize-key.txt
        - name: diags-in-cache
          valueFrom:
            path: /tmp/diags-in-cache.txt
    container:
      image: "{{inputs.parameters.image}}"
      command: ["/bin/bash", "-c"]
      args: 
      - |
        echo "{{inputs.parameters.run}}" | cut -c6- | sed 's/\//-/g' > /tmp/memoize-key.txt
        memoizeKey=$(cat /tmp/memoize-key.txt)
        gsutil ls gs://vcm-ml-archive/prognostic_run_diags/$memoizeKey > /dev/null
        if [[ $? -eq 0 ]]; then
            echo "Prognostic run diagnostics detected in cache for given run."
            echo "{{inputs.parameters.run}}"
            echo "true" > /tmp/diags-in-cache.txt
        else
            echo "No prognostic run diagnostics detected in cache for given run. Will compute."
            echo "{{inputs.parameters.run}}"
            echo "false" > /tmp/diags-in-cache.txt
        fi
  - name: copy-diags-to-output
    inputs:
      parameters:
        - name: memoize-key
        - name: output
        - name: image
    container:
      image: "{{inputs.parameters.image}}"
      command: ["/bin/bash", "-x", "-e", "-c"]
      args:
      - | 
        gsutil cp gs://vcm-ml-archive/prognostic_run_diags/{{inputs.parameters.memoize-key}}/diags.nc {{inputs.parameters.output}}/diags.nc	
        gsutil cp gs://vcm-ml-archive/prognostic_run_diags/{{inputs.parameters.memoize-key}}/metrics.json {{inputs.parameters.output}}/metrics.json 
  - name: compute-diags
    inputs:
      parameters:
        - name: run
        - name: memoize-key
        - name: image
        - name: flags
    tolerations:
    - key: "dedicated"
      operator: "Equal"
      value: "climate-sim-pool"
      effect: "NoSchedule"
    container:
      image: '{{inputs.parameters.image}}'
      command: ["/bin/bash", "-x", "-e", "-c"]
      args:
      - | 
        python save_prognostic_run_diags.py {{inputs.parameters.flags}} \
          {{inputs.parameters.run}} diags.nc
        python metrics.py diags.nc > metrics.json
        gsutil cp diags.nc gs://vcm-ml-archive/prognostic_run_diags/{{inputs.parameters.memoize-key}}/diags.nc		
        gsutil cp metrics.json gs://vcm-ml-archive/prognostic_run_diags/{{inputs.parameters.memoize-key}}/metrics.json
      workingDir: /home/jovyan/fv3net/workflows/prognostic_run_diags
      env:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        value: /secret/gcp-credentials/key.json
      - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
        value: /secret/gcp-credentials/key.json
      volumeMounts:
      - mountPath: /secret/gcp-credentials
        name: gcp-key-secret
      resources:
        requests:
            memory: "12Gi"
            cpu: "1000m"
        limits:
            memory: "12Gi"
            cpu: "1000m"
  - name: movie
    inputs:
      parameters:
      - name: run
      - name: output
    tolerations:
    - key: "dedicated"
      operator: "Equal"
      value: "climate-sim-pool"
      effect: "NoSchedule"
    container:
      image: '{{workflow.parameters.docker-image}}'
      command: ["/bin/bash", "-x", "-e", "-c"]
      args:
      - |
        python generate_movie_stills.py {{inputs.parameters.run}} /tmp/movie_stills
        bash stitch_movie_stills.sh /tmp/movie_stills {{inputs.parameters.output}}
      workingDir: /home/jovyan/fv3net/workflows/prognostic_run_diags
      env:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        value: /secret/gcp-credentials/key.json
      - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
        value: /secret/gcp-credentials/key.json
      volumeMounts:
      - mountPath: /secret/gcp-credentials
        name: gcp-key-secret
      resources:
        requests:
            memory: "8Gi"
            cpu: "8000m"
        limits:
            memory: "8Gi"
            cpu: "8000m"
