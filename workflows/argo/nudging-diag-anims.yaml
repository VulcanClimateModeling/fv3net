apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: nudging-diag-anims
spec:
  entrypoint: nudging-diag-anims
  volumes:
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
  serviceAccountName: integration-tests
  tolerations:
    - effect: NoSchedule
      key: dedicated
      value: climate-sim-pool
  templates:
    - name: nudging-diag-anims
      inputs:
        parameters:
          - name: image_tag
          - name: nudging_root_path
          - name: reference_restart_path
          - name: reference_gfs_physics_zarr_path
          - name: output_path
      container:
        image: us.gcr.io/vcm-ml/fv3net:{{inputs.parameters.image_tag}}
        workingDir: /home/jovyan/fv3net/workflows/nudging_diag_animations
        command: ["bash", "-c", "-x"]
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
        args:
          - bash make_nudging_animations.sh \
              {{inputs.parameters.nudging_root_path}}
              {{inputs.parameters.reference_restart_path}}
              {{inputs.parameters.reference_gfs_physics_zarr_path}}
              {{inputs.parameters.output_path}}

        resources:
          requests:
            memory: "20Gi"
            cpu: "1000m"
          limits:
            memory: "20Gi"
            cpu: "1000m"
