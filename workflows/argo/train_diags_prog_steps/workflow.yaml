apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: train-diags-prog
spec:
  arguments:
    parameters:
      - name: image-tag
      - name: root
      - name: train-test-data
      - name: training-config
      - name: train-times
      - name: initial-condition
      - name: prognostic-run-config
      - name: reference-restarts
      - name: store-true-args
        value: " "
      - name: test-times
      - name: public-report-output
  serviceAccountName: integration-tests
  tolerations:
    - effect: NoSchedule
      key: dedicated
      value: climate-sim-pool
  entrypoint: main
  volumes:
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
  templates:
  - name: main
    dag:
      tasks:
      - name: train-model
        templateRef:
          name: training-rf
          template: training-rf
        arguments:
          parameters:
            - name: image
              value: "us.gcr.io/vcm-ml/fv3net:{{workflow.parameters.image-tag}}"
            - name: input
              value: "{{workflow.parameters.train-test-data}}"
            - name: config
              value: "{{workflow.parameters.training-config}}"
            - name: times
              value: "{{workflow.parameters.train-times}}"
            - name: output
              value: "{{workflow.parameters.root}}/trained_model"
      - name: prognostic-run
        dependencies: [train-model]
        templateRef:
          name: prognostic-run
          template: prognostic-run
        arguments:
          parameters:
              - name: image-tag
                value: "{{workflow.parameters.image-tag}}"
              - name: initial-condition
                value: "{{workflow.parameters.initial-condition}}"
              - name: config
                value: "{{workflow.parameters.prognostic-run-config}}"
              - name: reference-restarts
                value: "{{workflow.parameters.reference-restarts}}"
              - name: trained-ml
                value: "{{workflow.parameters.root}}/trained_model"
              - name: output
                value: "{{workflow.parameters.root}}/prognostic_run"
              - name: store-true-args
                value: "{{workflow.parameters.store-true-args}}"
      - name: offline-diags
        dependencies: [train-model]
        templateRef:
          name: offline-diags
          template: offline-diags
        arguments:
          parameters:
              - name: image-tag
                value: "{{workflow.parameters.image-tag}}"
              - name: ml-model
                value: "{{workflow.parameters.root}}/trained_model/sklearn_model.pkl"
              - name: config
                value: "{{workflow.parameters.training-config}}"
              - name: times
                value: "{{workflow.parameters.test-times}}"
              - name: offline-diags-output
                value: "{{workflow.parameters.root}}/offline_diags"
              - name: report-output
                value: "{{workflow.parameters.public-report-output}}"
              - name: data-path
                value: "{{workflow.parameters.train-test-data}}"