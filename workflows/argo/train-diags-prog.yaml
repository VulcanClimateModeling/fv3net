apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: train-diags-prog
spec:
  serviceAccountName: integration-tests
  tolerations:
    - effect: NoSchedule
      key: dedicated
      value: climate-sim-pool
  entrypoint: train-diags-prog
  volumeClaimTemplates:
    - metadata:
        name: work-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast
        resources:
          requests:
            storage: 100Gi
  volumes:
    - name: workdir
      emptyVol: {}
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
  templates:
  - name: train-diags-prog
    inputs:
      parameters:
        - name: root
        - name: train-routine
          value: sklearn
        - name: train-test-data
        - name: training-config
        - name: train-times
        - name: initial-condition
        - name: prognostic-run-config
        - name: reference-restarts
        - name: flags
          value: " "
        - name: test-times
        - name: public-report-output
        - {name: chunks, value: "{}"}  # by default just use chunks defined in post_process.py
        - {name: segment-count, value: "1"}
        - {name: cpu-prog, value: "6"}
        - {name: memory-prog, value: 6Gi}
        - {name: work-volume-name, value: work-volume}
        - {name: memory-training, value: 6Gi}
        - {name: memory-offline-diags, value: 6Gi}
    dag:
      tasks:
      - name: train-model
        templateRef:
          name: training
          template: training
        arguments:
          parameters:
            - name: routine
              value: "fv3fit.{{inputs.parameters.train-routine}}"
            - name: input
              value: "{{inputs.parameters.train-test-data}}"
            - name: config
              value: "{{inputs.parameters.training-config}}"
            - name: times
              value: "{{inputs.parameters.train-times}}"
            - name: output
              value: "{{inputs.parameters.root}}/trained_model"
            - name: memory
              value: "{{inputs.parameters.memory-training}}"
      - name: prognostic-run
        dependencies: [train-model]
        templateRef:
          name: prognostic-run
          template: prognostic-run
        arguments:
          parameters:
              - name: initial-condition
                value: "{{inputs.parameters.initial-condition}}"
              - name: config
                value: "{{inputs.parameters.prognostic-run-config}}"
              - name: reference-restarts
                value: "{{inputs.parameters.reference-restarts}}"
              - name: output
                value: "{{inputs.parameters.root}}/prognostic_run"
              - name: flags
                value: "{{inputs.parameters.flags}} --model_url {{inputs.parameters.root}}/trained_model"
              - name: chunks
                value: "{{inputs.parameters.chunks}}"
              - name: segment-count
                value: "{{inputs.parameters.segment-count}}"
              - name: cpu
                value: "{{inputs.parameters.cpu-prog}}"
              - name: memory
                value: "{{inputs.parameters.memory-prog}}"
              - name: work-volume-name
                value: "{{inputs.parameters.work-volume-name}}"
      - name: offline-diags
        dependencies: [train-model]
        templateRef:
          name: offline-diags
          template: offline-diags
        arguments:
          parameters:
              - name: ml-model
                value: "{{inputs.parameters.root}}/trained_model"
              - name: config
                value: "{{inputs.parameters.training-config}}"
              - name: times
                value: "{{inputs.parameters.test-times}}"
              - name: offline-diags-output
                value: "{{inputs.parameters.root}}/offline_diags"
              - name: report-output
                value: "{{inputs.parameters.public-report-output}}"
              - name: data-path
                value: "{{inputs.parameters.train-test-data}}"
              - name: memory
                value: "{{inputs.parameters.memory-offline-diags}}"
      - name: online-diags
        dependencies: [prognostic-run]
        templateRef:
          name: prognostic-run-diags
          template: diagnostics
        arguments:
          parameters:
              - name: run
                value: "{{inputs.parameters.root}}/prognostic_run"
              - name: output
                value: "{{inputs.parameters.root}}/prognostic_run_diags"
