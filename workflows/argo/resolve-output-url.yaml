# vim: set sts=2 ts=2 tw=2 sw=2 :
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: resolve-output-url
spec:
  templates:
    - name: resolve-output-url
      inputs:
        parameters:
          - name: bucket
          - name: project
          - name: tag
      script:
        image: debian:9.4
        command: [bash]
        source: |
          set -e
          remove_slashes () {
              echo $(echo $1 | sed -e 's~/~-~')
          }
          DATE=$(date +'%F')
          BUCKET=$(remove_slashes {{inputs.parameters.bucket}})
          PROJECT=$(remove_slashes {{inputs.parameters.project}})
          TAG=$(remove_slashes {{inputs.parameters.tag}})
          echo "gs://${BUCKET}/${PROJECT}/${DATE}/${TAG}"
    - name: write-config-sha1
      inputs:
        parameters:
          - name: output-url
          - {name: config-sha1, value: ""}
      script:
        image: us.gcr.io/vcm-ml/prognostic_run
        command: [bash]
        source: |
          set -e
          if [[ -n "{{inputs.parameters.config-sha1}}" ]]; then
            echo "{{inputs.parameters.config-sha1}}" >> config-sha1.txt
            gsutil cp config-sha1.txt "{{inputs.parameters.output-url}}/config-sha1.txt"
          fi
          
          