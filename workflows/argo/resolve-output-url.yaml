# vim: set sts=2 ts=2 tw=2 sw=2 :
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: resolve-output-url
spec:
  templates:
    - name: resolve-output-url
      inputs:
        parameters:
          - name: bucket
          - name: project
          - name: tag
      script:
        image: debian:9.4
        command: [bash]
        source: |
          set -e
          remove_slashes () {
              echo $(echo $1 | sed -e 's~/~-~')
          }
          DATE=$(date +'%F')
          BUCKET=$(remove_slashes {{inputs.parameters.bucket}})
          PROJECT=$(remove_slashes {{inputs.parameters.project}})
          TAG=$(remove_slashes {{inputs.parameters.tag}})
          echo "gs://${BUCKET}/${PROJECT}/${DATE}/${TAG}"
    - name: write-image-tags
      inputs:
        parameters:
          - name: output-url
          - {name: image-tags, value: ""}
      script:
        image: us.gcr.io/vcm-ml/prognostic_run
        command: [bash]
        source: |
          set -e
          cat << EOF > image-tags.yaml
          {{inputs.parameters.image-tags}}
          EOF
          if [[ -n "{{inputs.parameters.image-tags}}" ]]; then
            gsutil cp image-tags.yaml "{{inputs.parameters.output-url}}/image-tags.yaml"
          fi
          
          