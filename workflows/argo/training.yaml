# vim: set sts=2 ts=2 tw=2 sw=2 :
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: training
spec:
  entrypoint: training
  volumeClaimTemplates:
    - metadata:
        name: work-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast
        resources:
          requests:
            storage: 100Gi
  volumes:
    - name: workdir
      emptyVol: {}
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
  templates:
    - name: training
      inputs:
        parameters:
          - name: input
          - name: config
          - name: times
          - name: output
          - {name: memory, value: 6Gi}
          - {name: flags, value: " "}
      container:
        image: us.gcr.io/vcm-ml/fv3fit
        command: ["bash", "-c", "-x"]
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
        args:
          - |

            cat <<EOF >config.yaml
            {{inputs.parameters.config}}
            EOF
            
            cat << EOF > times.json
            {{inputs.parameters.times}}
            EOF

            echo "Configuration:"
            cat config.yaml
            
            echo {{inputs.parameters.routine}}
    
            python -m fv3fit.train
              {{inputs.parameters.input}} \
              config.yaml \
              {{inputs.parameters.output}} \
              --timesteps-file times.json \
              {{inputs.parameters.flags}}
      tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "climate-sim-pool"
        effect: "NoSchedule"      
      podSpecPatch: |
        containers:
          - name: main
            resources:
              limits:
                cpu: "1000m"
                memory: "{{inputs.parameters.memory}}"
              requests:
                cpu: "1000m"
                memory: "{{inputs.parameters.memory}}"
