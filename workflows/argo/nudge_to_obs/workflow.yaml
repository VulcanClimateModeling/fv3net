apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: nudge-to-obs
spec:
  arguments:
    parameters:
      - name: nudging-config
      - name: output-url
      - {name: segment-count, value: "1"}
      - {name: cpu, value: "6"}
      - {name: memory, value: 8Gi}
      - {name: nudge-url, value: gs://vcm-ml-data/2019-12-02-year-2016-T85-nudging-data}
      - {name: flags, value: " "}
  entrypoint: main
  volumes:
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
  templates:
    - name: main
      steps:
        - - name: nudge-to-obs
            template: nudge-to-obs
            arguments:
              parameters:
              - name: output-url
                value: "{{workflow.parameters.output-url}}"
              - name: nudging-config
                value: "{{workflow.parameters.nudging-config}}"
              - {name: segment-count, value: "{{workflow.parameters.segment-count}}"}
              - {name: cpu, value: "{{workflow.parameters.cpu}}"}
              - {name: memory, value: "{{workflow.parameters.memory}}"}
              - {name: nudge-url, value: "{{workflow.parameters.nudge-url}}"}
              - {name: flags, value: "{{workflow.parameters.flags}}"}
    - name: nudge-to-obs
      inputs:
        parameters:
          - name: nudging-config
          - name: output-url
          - {name: segment-count, value: "1"}
          - {name: cpu, value: "6"}
          - {name: memory, value: 8Gi}
          - {name: nudge-url, value: gs://vcm-ml-data/2019-12-02-year-2016-T85-nudging-data}
          - {name: flags, value: " "}
      steps:
        - - template: prepare-config
            name: prepare-config
            arguments:
              parameters:
                - {name: nudging-config, value: "{{inputs.parameters.nudging-config}}"}
                - {name: nudge-url, value: "{{inputs.parameters.nudge-url}}"}
                - {name: segment-count, value: "{{inputs.parameters.segment-count}}"}
                - {name: flags, value: "{{inputs.parameters.flags}}"}
        - - name: run-model
            templateRef:
              name: run-fv3gfs
              template: run-fv3gfs
            arguments:
              artifacts:
                - {name: fv3config, from: "{{steps.prepare-config.outputs.artifacts.fv3config}}"}
                - {name: runfile, from: "{{steps.prepare-config.outputs.artifacts.runfile}}"}
              parameters:
                - {name: chunks, value: "{{steps.prepare-config.outputs.parameters.chunks}}"}
                - {name: output-url, value: "{{inputs.parameters.output-url}}"}
                - {name: segment-count, value: "{{inputs.parameters.segment-count}}"}
                - {name: cpu, value: "{{inputs.parameters.cpu}}"}
                - {name: memory, value: "{{inputs.parameters.memory}}"}
    - name: prepare-config
      inputs:
        parameters:
          - {name: nudging-config}
          - {name: nudge-url}
          - name: segment-count
          - name: flags
      outputs:
        artifacts:
          - {name: fv3config, path: /tmp/fv3config.yaml}
          - name: runfile
            path: /home/jovyan/fv3net/workflows/prognostic_c48_run/nudge_to_obs/runfile.py
        parameters:
          - name: chunks
            valueFrom:
              path: /home/jovyan/fv3net/workflows/prognostic_c48_run/nudge_to_obs/chunks.yaml
      container:
        image: us.gcr.io/vcm-ml/fv3net
        command: ["/bin/bash", "-c", "-e", "-x"]
        workingDir: /home/jovyan/fv3net/workflows/prognostic_c48_run/nudge_to_obs
        args:
        - |
          echo "{{inputs.parameters.nudging-config}}" > config.yaml
          python prepare_config.py --nudge-url "{{inputs.parameters.nudge-url}}" \
              --segment-count "{{inputs.parameters.segment-count}}" \
              {{inputs.parameters.flags}} \
              config.yaml > /tmp/fv3config.yaml
