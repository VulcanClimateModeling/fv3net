# vim: set ts=2 sw=2 sts=2:
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: nudging
spec:
  arguments:
    parameters:
      - name: nudging-config
      - name: output-url
      - name: fv3gfs-image
      - name: fv3net-image
        value: us.gcr.io/vcm-ml/fv3net:5cd4db3971ca10276cb6b22cfe6c22f3ea8297e8
      - name: post-process-image
      - name: times
        value: ""
      - {name: segment-count, value: "1"}
      - {name: cpu, value: "6"}
      - {name: memory, value: 8Gi}
      - {name: use-default-chunks, value: "true"}
      - {name: custom-chunks, value: "{}"}
      - {name: work-volume-name, value: work-volume}
      - {name: external-volume-name, value: restart-data}
  entrypoint: main
  volumeClaimTemplates:
    - metadata:
        name: work-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: fast
        resources:
          requests:
            storage: 100Gi
  volumes:
    - name: restart-data
      persistentVolumeClaim:
        claimName: nudging-read-only
        readOnly: true
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
  templates:
    - name: main
      steps:
        - - name: nudging
            template: nudging
            arguments:
              parameters:
              - name: fv3net-image
                value: "{{workflow.parameters.fv3net-image}}"
              - name: fv3gfs-image
                value: "{{workflow.parameters.fv3gfs-image}}"
              - name: post-process-image
                value: "{{workflow.parameters.post-process-image}}"
              - name: times
                value: "{{workflow.parameters.times}}"
              - name: output-url
                value: "{{workflow.parameters.output-url}}"
              - name: nudging-config
                value: "{{workflow.parameters.nudging-config}}"
              - {name: segment-count, value: "{{workflow.parameters.segment-count}}"}
              - {name: cpu, value: "{{workflow.parameters.cpu}}"}
              - {name: memory, value: "{{workflow.parameters.memory}}"}
              - {name: use-default-chunks, value: "{{workflow.parameters.use-default-chunks}}"}
              - {name: custom-chunks, value: "{{workflow.parameters.custom-chunks}}"}
              - {name: work-volume-name, value: "{{workflow.parameters.work-volume-name}}"}
              - {name: external-volume-name, value: "{{workflow.parameters.external-volume-name}}"}
    - name: nudging
      inputs:
        parameters:
          - name: nudging-config
          - name: times
          - name: output-url
          - name: fv3gfs-image
            value: us.gcr.io/vcm-ml/fv3gfs-wrapper:46b1d8742ee220ebeb14942e0a0f43da963cc0cf
          - name: fv3net-image
            value: us.gcr.io/vcm-ml/fv3net:5cd4db3971ca10276cb6b22cfe6c22f3ea8297e8
          - name: post-process-image
          - {name: segment-count, value: "1"}
          - {name: cpu, value: "6"}
          - {name: memory, value: 8Gi}
          - {name: use-default-chunks, value: "true"}
          - {name: custom-chunks, value: "{}"}
          - {name: work-volume-name, value: work-volume}
          - {name: external-volume-name, value: restart-data}
      steps:
        - - template: prepare-config
            name: prepare-config
            arguments:
              parameters:
                - {name: fv3net-image, value: "{{inputs.parameters.fv3net-image}}"}
                - {name: nudging-config, value: "{{inputs.parameters.nudging-config}}"}
                - {name: times, value: "{{inputs.parameters.times}}"}
                - {name: use-default-chunks, value: "{{inputs.parameters.use-default-chunks}}"}
                - {name: custom-chunks, value: "{{inputs.parameters.custom-chunks}}"}
        - - name: run-model
            templateRef:
              name: run-fv3gfs
              template: run-fv3gfs
            arguments:
              artifacts:
                - {name: fv3config, from: "{{steps.prepare-config.outputs.artifacts.fv3config}}"}
                - {name: runfile, from: "{{steps.prepare-config.outputs.artifacts.runfile}}"}
              parameters:
                - {name: chunks, value: "{{steps.prepare-config.outputs.parameters.chunks}}"}
                - {name: fv3gfs-image, value: "{{inputs.parameters.fv3gfs-image}}"}
                - {name: output-url, value: "{{inputs.parameters.output-url}}"}
                - {name: post-process-image, value: "{{inputs.parameters.post-process-image}}"}
                - {name: segment-count, value: "{{inputs.parameters.segment-count}}"}
                - {name: cpu, value: "{{inputs.parameters.cpu}}"}
                - {name: memory, value: "{{inputs.parameters.memory}}"}
                - {name: work-volume-name, value: "{{inputs.parameters.work-volume-name}}"}
                - {name: external-volume-name, value: "{{inputs.parameters.external-volume-name}}"}
    - name: prepare-config
      inputs:
        parameters:
          - {name: fv3net-image}
          - {name: nudging-config}
          - {name: times}
          - {name: use-default-chunks}
          - {name: custom-chunks}
      outputs:
        artifacts:
          - name: fv3config
            path: /tmp/fv3config.yaml
          - name: runfile
            path: /home/jovyan/fv3net/workflows/prognostic_c48_run/nudging/nudging_runfile.py
        parameters:
          - name: chunks
            valueFrom:
              path: /tmp/chunks.yaml
      container:
        image: us.gcr.io/vcm-ml/fv3net
        command: ["/bin/bash", "-c"]
        workingDir: /home/jovyan/fv3net/workflows/prognostic_c48_run/nudging
        args:
        - |
          if [[ "{{inputs.parameters.use-default-chunks}}" == "true" ]]; then
            cp /home/jovyan/fv3net/workflows/prognostic_c48_run/nudging/nudging_chunks.yaml /tmp/chunks.yaml
          else
            echo "{{inputs.parameters.custom-chunks}}" > /tmp/chunks.yaml
          fi

          cat << EOF > times.json
          {{inputs.parameters.times}}
          EOF

          cat << EOF > config.yaml
          {{inputs.parameters.nudging-config}}
          EOF

          python prepare_config.py \
            --timesteps times.json \
            config.yaml \
            > /tmp/fv3config.yaml
