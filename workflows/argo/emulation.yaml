apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: emulation-
spec:
  entrypoint: emulation
  volumes:
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
  volumeClaimTemplates:
    - metadata:
        name: work-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 100Gi
  tolerations:
    - effect: NoSchedule
      key: dedicated
      value: med-sim-pool
  arguments:
    parameters:
      - name: train-data
      - name: train-config
      - name: model-output
      - name: report-output
      - name: num-test-batches
        value: 96
      - name: is-classifier
        value: false
      - name: emulation-image
      - name: report-image
  templates:
    - name: emulation
      steps:
      - - name: train-model
          template: train-model
          arguments:
            parameters:
            - name: train-data
              value: "{{workflow.parameters.train-data}}"
            - name: train-config
              value: "{{workflow.parameters.train-config}}"
            - name: emulation-image
              value: "{{workflow.parameters.emulation-image}}"
      - - name: upload-model
          template: upload-model
          arguments:
            parameters:
            - name: model-output
              value: "{{workflow.parameters.model-output}}"
      - - name: regression-report
          template: regression-model-diags
          when: "{{workflow.parameters.is-classifier}} == false"
          arguments:
            parameters:
            - name: train-data
              value: "{{workflow.parameters.train-data}}"
            - name: num-test-batches
              value: "{{workflow.parameters.num-test-batches}}"
            - name: model-input
              value: "{{workflow.parameters.model-output}}keras_model"
            - name: report-image
              value: "{{workflow.parameters.report-image}}"
      - - name: classifier-report
          template: classifier-model-diags
          when: "{{workflow.parameters.is-classifier}} == true"
          arguments:
            parameters:
            - name: train-data
              value: "{{workflow.parameters.train-data}}"
            - name: num-test-batches
              value: "{{workflow.parameters.num-test-batches}}"
            - name: model-input
              value: "{{workflow.parameters.model-output}}keras_model"
            - name: report-image
              value: "{{workflow.parameters.report-image}}"
      - - name: upload-report
          template: upload-report
          arguments:
            parameters:
            - name: report-output
              value: "{{workflow.parameters.report-output}}"
    - name: train-model
      inputs:
        parameters:
          - name: train-data
          - name: train-config
          - name: emulation-image
      container:
        image: "{{inputs.parameters.emulation-image}}"
        command: ["bash", "-c", "-x"]
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
          - mountPath: /mnt/data
            name: work-volume
        args:
          - |

            cat <<EOF > /mnt/data/config.yaml
            {{inputs.parameters.train-config}}
            EOF

            echo "Configuration:"
            cat /mnt/data/config.yaml
    
            python -m fv3fit.emulation \
              {{inputs.parameters.train-data}} \
              /mnt/data/config.yaml \
              /mnt/data/

        resources:
          requests:
            memory: "14Gi"
            cpu: "6"
          limits:
            memory: "25Gi"
            cpu: "7500m"
    - name: regression-model-diags
      inputs:
        parameters:
          - name: train-data
          - name: model-input
          - name: num-test-batches
          - name: report-image
      container:
        image: "{{inputs.parameters.report-image}}"
        command: ["bash", "-c", "-x"]
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
          - mountPath: /mnt/data
            name: work-volume
        args:
          - |
            python /fv3fit/emulation_diags/generate_report.py \
              "{{inputs.parameters.model-input}}" \
              {{inputs.parameters.train-data}} \
              /mnt/data/report/ \
              --num-test-batches {{inputs.parameters.num-test-batches}}
        resources:
          requests:
            memory: "14Gi"
            cpu: "6"
          limits:
            memory: "25Gi"
            cpu: "7500m"
    - name: classifier-model-diags
      inputs:
        parameters:
          - name: train-data
          - name: model-input
          - name: num-test-batches
            value: 96
          - name: report-image
      container:
        image: "{{inputs.parameters.report-image}}"
        command: ["bash", "-c", "-x"]
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
          - mountPath: /mnt/data
            name: work-volume
        args:
          - |
            python /fv3fit/emulation_diags/classifier_report.py \
              "{{inputs.parameters.model-input}}" \
              {{inputs.parameters.train-data}} \
              /mnt/data/report/ \
              --num-test-batches {{inputs.parameters.num-test-batches}}
        resources:
          requests:
            memory: "14Gi"
            cpu: "6"
          limits:
            memory: "25Gi"
            cpu: "7500m"
    - name: upload-model
      inputs:
        parameters:
        - name: model-output
      container:
        image: google/cloud-sdk:latest
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
          - mountPath: /mnt/data
            name: work-volume
        command: [bash, "-c", "-x"]
        args:
          - |
            gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS

            gsutil -m cp -r /mnt/data/keras_model "{{inputs.parameters.model-output}}"
            gsutil -m cp -r /mnt/data/config.yaml "{{inputs.parameters.model-output}}"
        resources:
          requests:
            memory: "2Gi"
            cpu: "1"
    - name: upload-report
      inputs:
        parameters:
        - name: report-output
      container:
        image: google/cloud-sdk:latest
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
          - mountPath: /mnt/data
            name: work-volume
        command: [bash, "-c", "-x"]
        args:
          - |
            gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
            gsutil -m cp -r /mnt/data/report/* "{{inputs.parameters.report-output}}"/
        resources:
          requests:
            memory: "2Gi"
            cpu: "1"
