apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app: fv3run
    job-name: ${JOBNAME}
  name: ${JOBNAME}
  namespace: default
spec:
  backoffLimit: 0
  completions: 1
  parallelism: 1
  template:
    metadata:
      labels:
        app: fv3run
        job-name: ${JOBNAME}
    spec:
      initContainers:
        - name: fv3gfs
          command:
          - python
          - -m
          - fv3config.fv3run._native_main
          - '[["${CONFIG}", "/mnt/data/"],
            {"runfile": "${RUNFILE}", "capture_output":
            false}]'
          env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
          image: ${DOCKER_IMAGE}
          imagePullPolicy: Always
          resources:
            limits:
              memory: 3600M
            requests:
              cpu: "6"
              memory: 3600M
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - name: data
            mountPath: /mnt/data
            readOnly: false
          - name: gcp-key-secret
            mountPath: /secret/gcp-credentials
            readOnly: true
      containers:
        - name: test
          image: google/cloud-sdk:latest
          command: ["/bin/bash"]
          args:
            - -c  
            - |
              gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS && \
              gsutil -m -q rsync -r -e /mnt/data/ ${OUTPUT_URL}
          env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          imagePullPolicy: Always
          resources:
            limits:
              memory: 3600M
            requests:
              cpu: "6"
              memory: 3600M
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - name: data
            mountPath: /mnt/data
          - name: gcp-key-secret
            mountPath: /secret/gcp-credentials
            readOnly: true
 
      dnsPolicy: ClusterFirst
      restartPolicy: Never
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      tolerations:
      - effect: NoSchedule
        key: dedicated
        value: climate-sim-pool
      volumes:
      - name: data
        emptyDir: {}
      - name: gcp-key-secret
        secret:
          defaultMode: 420
          secretName: gcp-key
