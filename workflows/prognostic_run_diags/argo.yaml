apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: prognostic-run-diags-
spec:
  arguments:
    parameters:
    - name: runs
    - name: output_url
  entrypoint: all
  volumes:
  - name: gcp-credentials-user-gcp-sa
    secret:
      secretName: gcp-key
  templates:
   - name: all
     steps:
      - - name: diags
          withParam: "{{workflow.parameters.runs}}"
          templateRef:
            name: prognostic-diagnostics
            template: diags
          arguments:
            parameters:
              - name: run
                value: "{{item.url}}"
              - name: output
                value: "{{workflow.parameters.output_url}}/{{item.name}}.nc"
      - - name: metrics
          withParam: "{{workflow.parameters.runs}}"
          templateRef:
            name: prognostic-diagnostics
            template: metrics
          arguments:
            parameters:
              - name: output
                value: "{{workflow.parameters.output_url}}/{{item.name}}.json"
            artifacts:
              - name: diags-netcdf
                gcs: 
                  key: "{{workflow.parameters.output_url}}/{{item.name}}.nc"
      - - name: generate-notebook
          templateRef: 
            name: prognostic-diagnostics
            template: notebook
