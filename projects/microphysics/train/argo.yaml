apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: train-microphysics-
spec:
  entrypoint: training
  volumes:
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
    - name: wandb-key
      secret:
        defaultMode: 420
        secretName: wandb-andrep
  templates:
    - name: training
      inputs:
        parameters:
          - name: training-config
          - {name: flags, value: " "}
          # - {name: memory, value: "8Gi"}
      container:
        image: us.gcr.io/vcm-ml/prognostic_run:94fe4d44f231d0a91e90008a4916cfa342d50339
        command: ["bash", "-c", "-x"]
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
          - name: WANDB_KEYFILE
            value: /secret/wandb-api/apikey
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
          - mountPath: /secret/wandb-api
            name: wandb-key
        resources:
          limits:
            cpu: "7"
            memory: "8Gi"
          requests:
            cpu: "4"
            memory: "8Gi"
        args:
          # The use of the API key here is a security problem
          # It's logged by argo...
          - |
            export WANDB_API_KEY=$(cat $WANDB_KEYFILE)

            cat <<EOF >training_config.yaml
            {{inputs.parameters.training-config}}
            EOF

            python3 -m fv3fit.train_microphysics \
              --config-path training_config.yaml \
              {{inputs.parameters.flags}}
      tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "med-sim-pool"
        effect: "NoSchedule"  
