apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: create-training-microphysics-
  labels:
    app: microphysics-training
spec:
  entrypoint: main
  arguments:
    parameters:
      - name: tag
      - name: output_frequency
        value: "18000"
  volumes:
  - name: gcp-key-secret
    secret:
      secretName: gcp-key
  templates:
  - name: main
    steps:
      - - name: run-model
          template: run-model
          arguments:
            parameters:
              - name: month
                value: "{{item}}"
          withItems:
            - "01"
            # - "02"
            # - "03"
            # - "04"
            # - "05"
            # - "06"
            # - "07"
            # - "08"
            # - "09"
            # - "10"
            # - "11"
            # - "12"
  - name: run-model
    inputs:
      parameters:
      - name: month
    tolerations:
    - key: "dedicated"
      operator: "Equal"
      value: "med-sim-pool"
      effect: "NoSchedule"
    container:
      image: "us.gcr.io/vcm-ml/prognostic_run@sha256:5cd2c1e69920e061702dff121f06395c1c65885e8a67fc943e10ef89b190c7e4"
      imagePullPolicy: Always
      workingDir: "/fv3net/projects/microphysics/create_training"
      resources:
        requests:
          memory: "6Gi"
          cpu: "7500m"
        limits:
          memory: "8Gi"
          cpu: "7500m"
      envFrom:
      - secretRef:
          name: wandb-andrep
      env:
      - name: GOOGLE_APPLICATION_CREDENTIALS 
        value: /secret/gcp-credentials/key.json
      - name: WANDB_RUN_GROUP
        value: "{{workflows.parameters.tag}}"
      - name: WANDB_JOB_TYPE
        value: training-run
      volumeMounts:
      - mountPath: /secret/gcp-credentials
        name: gcp-key-secret
      command:
        - ./run_single.sh
        - "{{workflow.parameters.config}}"
        - "{{inputs.parameters.month}}"
        - "{{workflow.parameters.tag}}"
        - "{{workflow.parameters.output_frequency}}"