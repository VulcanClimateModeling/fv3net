apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: prognostic-microphysics-
spec:
  entrypoint: prognostic-run
  arguments:
    parameters:
      - name: tag
      - name: config
      - name: tf_model
      - name: output_frequency
        value: "10800"
      - name: do_prog_eval
        value: "false"
  templates:
  - name: prognostic-run
    steps:
    - - name: run-model
        template: run-model
        arguments:
          parameters:
          - name: tag
            value: "{{workflow.parameters.tag}}"
          - name: config
            value:  "{{workflow.parameters.config}}"
          - name: tf_model
            value: "{{workflow.parameters.tf_model}}"
          - name: output_frequency
            value: "{{workflow.parameters.output_frequency}}"
          - name: do_prog_eval
            value: "{{workflow.parameters.do_prog_eval}}"
    - - name: piggyback-diags
        template: piggyback-diags
        arguments:
          parameters:
          - name: tag
            value: "{{workflow.parameters.tag}}"
      - name: prognostic-diags
        template: prognostic-diags
        when: "{{workflow.parameters.do_prog_eval}} == true"
        arguments:
          parameters:
          - name: tag
            value: "{{workflow.parameters.tag}}"
  - name: run-model
    inputs:
      parameters:
      - name: tag
      - name: config
      - name: tf_model
      - name: output_frequency
    container:
      image: "us.gcr.io/vcm-ml/prognostic-run:test-micro-proj"
      workingDir: "/fv3net/projects/microphysics"
      command: [bash, -c]
      args: |
        WANDB_RUN_GROUP="{{inputs.parameters.tag}}"
        echo "{{inputs.parameters.config}}" > fv3config.yaml
        python3 scripts/prognostic_run.py \
          --tag "{{inputs.parameters.tag}}" \
          --config-path fv3config.yaml \
          --model "{{inputs.parameters.tf_model}}"
  - name: piggyback-diags
    inputs:
      parameters:
      - name: tag
    container:
      image: "us.gcr.io/vcm-ml/fv3net:test-micro-proj"
      workingDir: "/fv3net/projects/microphysics"
      command: [bash, -c]
      args: |
        python3 scripts/piggy-back.py {{inputs.parameters.tag}}
  - name: prognostic-diags
    inputs:
      parameters:
      - name: tag
    container:
      image: "us.gcr.io/vcm-ml/fv3net:test-micro-proj"
      workingDir: "/fv3net/projects/microphysics"
      command: [bash, -c]
      args: |
        python3 scripts/prognostic_evaluate.py {{inputs.parameters.tag}}
