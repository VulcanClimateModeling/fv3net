# This workflow demonstrates the use of a generator step which produces a list of items as a result.
# This list is subsequently used for expanding the next step into multiple parallel steps.
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: loops-param-result-
spec:
  entrypoint: loop-param-result-example
  parallelism: 10
  templates:
  - name: loop-param-result-example
    steps:
    - - name: generate
        template: gen-number-list
    - - name: sleep
        template: sleep-n-sec
        arguments:
          parameters:
          - name: name
            value: "{{item}}"
        withParam: "{{steps.generate.outputs.result}}"

  - name: gen-number-list
    script:
      image: google/cloud-sdk
      command: [python]
      source: |
        import subprocess
        import json
        bucket = 'gs://vcm-ml-data/2019-10-05-X-SHiELD-C3072-to-C384-re-uploaded-restart-data/*.tar'
        output = subprocess.check_output(['gsutil',  'ls', bucket])
        out_array = json.dumps(output.split())
        print(out_array)

  - name: sleep-n-sec
    inputs:
      parameters:
      - name: name
    container:
      image: alpine:latest
      command: [sh, -c]
      args: ["echo {{inputs.parameters.name}}"]
