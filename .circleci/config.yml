version: 2.1
orbs:
  gcp-gcr: circleci/gcp-gcr@0.6.1
  slack: circleci/slack@3.4.2
jobs:
  build_default:
    parameters:
      image:
        default: fv3net
        type: enum
        enum: ["prognostic_run", "post_process_run", "fv3net", "fv3fit", "fv3gfs_fv3net"]
    docker:
      - image: google/cloud-sdk
    environment:
      GOOGLE_PROJECT_ID: vcm-ml
      GOOGLE_COMPUTE_ZONE: us-central1
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/key.json
      IMAGE: <<parameters.image>>
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Authenticate docker with GCR
          command: |
            echo "$ENCODED_GOOGLE_CREDENTIALS" | base64 -d > "$GOOGLE_APPLICATION_CREDENTIALS"
            gcloud auth activate-service-account --key-file "$GOOGLE_APPLICATION_CREDENTIALS"
            gcloud auth configure-docker
      - checkout
      - add_ssh_keys:
          fingerprints:
            # - e2:b3:cd:50:62:39:92:db:fb:d5:2c:fc:d8:62:0d:b5
            # - 6e:e3:5f:3b:71:91:cb:86:0c:05:46:9c:eb:86:a1:7e
            # - 0e:2b:68:27:f9:6e:17:ab:dd:68:56:65:47:bd:08:45
            - 28:8a:c3:e4:58:e7:c0:11:2c:fc:62:84:85:91:1f:7d  # mcgibbon user key
      - run: ssh-add -l
      - run:
          name: "Pull submodules"
          command: |
            git submodule update --init --recursive
workflows:
  version: 2
  test_and_lint:
    jobs:
      - build_default:
          name: build_fv3gfs_fv3net
          matrix:
            parameters:
              image: ["fv3gfs_fv3net"]