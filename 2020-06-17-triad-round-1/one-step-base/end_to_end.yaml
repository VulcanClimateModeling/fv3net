storage_proto: gs
storage_root: vcm-ml-experiments/2020-06-17-triad-round-1
experiment:
  name: $JOBNAME
  unique_id: false
  steps_to_run:
    - coarsen_diagnostics
    - one_step_run
    - create_training_data
    - train_sklearn_model
    - prognostic_run
    - baseline_run

  steps_config:
    coarsen_diagnostics:
      command: python workflows/coarsen_c384_diagnostics/coarsen_c384_diagnostics.py
      args:
        c384_diagnostics:
          location: $C384_DIAGNOSTICS
        coarsening_config: $CONFIG/coarsen_c384_diagnostics.yaml

    one_step_run:
      command: python workflows/one_step_jobs/orchestrate_submit_jobs.py
      args:
        restart_data:
          location: $C48_RESTARTS
        experiment_yaml: $CONFIG/one_step_jobs.yaml
        docker_image: $PROGNOSTIC_RUN_IMAGE
        timesteps: /etc/times/one_step.json

    create_training_data:
      command: ./dataflow.sh submit -m fv3net.pipelines.create_training_data
      args:
        one_step_data:
          from: one_step_run
        diagnostics_data:
          from: coarsen_diagnostics
        timestep_splits: /etc/times/create_training_data.json
        --runner: DataflowRunner

    train_sklearn_model:
      command: python -m fv3net.regression.sklearn
      args:
        training_data:
          from: create_training_data
        train-config-file: $CONFIG/train_sklearn.yaml

    prognostic_run:
      command: python workflows/prognostic_c48_run/orchestrate_submit_job.py
      args:
        restart_data:
          location: $C48_RESTARTS
        ic_timestep: $IC_TIMESTEP
        --image-tag: $TAG
        --allow_fail: ''
        --prog_config_yml: $CONFIG/prognostic_run.yaml
        --model_url:
          from: train_sklearn_model

    baseline_run:
      command: python workflows/prognostic_c48_run/orchestrate_submit_job.py
      args:
        restart_data:
          location: $C48_RESTARTS
        ic_timestep: $IC_TIMESTEP
        --image-tag: $TAG
        --prog_config_yml: $CONFIG/prognostic_run.yaml
        --diagnostic_ml: ''
        --model_url:
          from: train_sklearn_model
