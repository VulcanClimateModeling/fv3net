apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app: partial-integration
  name: nudging-integration
spec:
  backoffLimit: 0
  template:
    metadata:
      generateName: nudging-integration-pod-
      labels:
        app: partial-integration
    spec:
      containers:
      - command: ["/bin/bash"]
        args:  ["tests/short_integration/nudging/minimal_entrypoint.sh"]
        image: us.gcr.io/vcm-ml/fv3net
        imagePullPolicy: Always
        envFrom:
          - configMapRef:
              name: nudging
        env:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/gcp-credentials/key.json
          - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
            value: /secret/gcp-credentials/key.json
          - name: CONFIG
            value: /etc/config
        name: nudging-integration
        resources:
          requests:
            cpu: "2"
            memory: 2G
        volumeMounts:
          - mountPath: /secret/gcp-credentials
            name: gcp-key-secret
            readOnly: true
          - mountPath:  /etc/config/
            name: config-vol
      restartPolicy: Never
      terminationGracePeriodSeconds: 30
      tolerations:
        - key: dedicated
          effect: NoSchedule
          value: climate-sim-pool
      volumes:
        - name: gcp-key-secret
          secret:
            defaultMode: 444
            secretName: gcp-key
        - name: config-vol
          configMap:
            name: nudging
---
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  name: e2e-pdb
spec:
  # will prevent voluntary evictions
  minAvailable: 100%
  selector:
    matchLabels:
      app: partial-integration
