storage_proto: gs
storage_root: vcm-ml-data/test-end-to-end-integration
experiment:
  name: end_to_end_test
  unique_id: True
  steps_to_run:
    #- coarsen_restarts  # this step is unreliable, so currently not part of integration test
    - coarsen_diagnostics
    - one_step_run
    - create_training_data
    - train_sklearn_model
    - test_sklearn_model
    - prognostic_run
    - baseline_run
  
  steps_config:
    coarsen_restarts:
      command: python -m fv3net.pipelines.coarsen_restarts
      args:
        data_to_coarsen:
          location: gs://vcm-ml-data/test-end-to-end-integration/C384-restarts
        grid_spec: 
          location: gs://vcm-ml-data/2020-01-06-C384-grid-spec-with-area-dx-dy
        source-resolution: 384
        target-resolution: 48
        --runner: DataflowRunner

    coarsen_diagnostics:
      command: python workflows/coarsen_c384_diagnostics/coarsen_c384_diagnostics.py
      args:
        c384_diagnostics: 
          location: gs://vcm-ml-data/test-end-to-end-integration/C384-diagnostics/gfsphysics_15min_coarse.zarr
        coarsening_config: tests/end_to_end_integration/coarsen_c384_diagnostics_integration.yml

    one_step_run:
      command: python workflows/one_step_jobs/orchestrate_submit_jobs.py
      args:
        restart_data:
          #from: coarsen_restarts  # uncomment this line and delete the following to include coarsening in test workflow
          location: gs://vcm-ml-data/test-end-to-end-integration/C48-input-for-one-step-jobs
        experiment_yaml: tests/end_to_end_integration/one_step_jobs_integration.yml
        docker_image: us.gcr.io/vcm-ml/prognostic_run:v0.1.1
        --config-version: v0.3

    create_training_data:
      command: python -m fv3net.pipelines.create_training_data
      args:
        one_step_data:
          from: one_step_run
        diagnostics_data:
          from: coarsen_diagnostics
        variable_filename: tests/end_to_end_integration/create_training_data_variable_names.yml
        --timesteps-per-output-file: 1
        --train-fraction: 0.5
        
    train_sklearn_model:
      command: python -m fv3net.regression.sklearn.train
      args:
        training_data:
          from: create_training_data
        train-config-file: tests/end_to_end_integration/train_sklearn_model_integration.yml
        
    test_sklearn_model: 
      command: python -m fv3net.diagnostics.sklearn_model_performance
      args:
        trained_model:
          from: train_sklearn_model
        testing_data:
          from: create_training_data
        diagnostics_data:
          from: coarsen_diagnostics
        variable_filename: tests/end_to_end_integration/test_sklearn_variable_names.yml
        --num_test_zarrs: 2
        --delete-local-results-after-upload: true

    prognostic_run:
      command: python workflows/prognostic_c48_run/orchestrate_submit_job.py
      args:
        restart_file_dir:
          from: one_step_run
        ic_timestep: "20160801.001500"
        docker_image: us.gcr.io/vcm-ml/prognostic_run:v0.1.1
        --prog_config_yml: tests/end_to_end_integration/prognostic_run_integration.yml
        --model_url:
          from: train_sklearn_model

    baseline_run:
      command: python workflows/prognostic_c48_run/orchestrate_submit_job.py
      args:
        restart_file_dir:
          from: one_step_run
        ic_timestep: "20160801.001500"
        docker_image: us.gcr.io/vcm-ml/prognostic_run:v0.1.1
        --prog_config_yml: tests/end_to_end_integration/prognostic_run_integration.yml


