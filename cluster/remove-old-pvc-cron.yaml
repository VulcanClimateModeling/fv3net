apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: pvc-delete-cron
spec:
  schedule: "27 3/6 * * *"
  successfulJobsHistoryLimit: 8
  startingDeadlineSeconds: 300
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: delete-old-pvc
            image: google/cloud-sdk
            command:
              - "/bin/bash"
              - "-c"
            args: 
              - |
                apt-get install -y jq 
                export HR_THRESHOLD=1

                # Selects PVCs that have deletion timestamp attribute (i.e., TERMINATING phase)
                export pvc_to_del=$(kubectl get pvc  -o json | 
                      jq --raw-output '.items[] | 
                      select(.metadata.deletionTimestamp != null) | 
                      "\(.metadata.name) \(.metadata.deletionTimestamp)"'
                )

                echo "Found terminating PVCs:"
                echo $pvc_to_del

                while read -r name_time; do
                    read -ra args <<< $name_time
                    name=${args[0]} # Name of PVC
                    del_time=${args[1]} # Time pvc marked for deletion

                    # Calculate time elapsed since PVC marked for deletion
                    del_time_s=$(date -u -d ${del_time} +%s)
                    curr_time_s=$(date -u +%s)
                    seconds=$((${curr_time_s} - ${del_time_s}))
                    hrs=$(($seconds / 60 / 60))

                    if [ ${hrs} -ge ${HR_THRESHOLD} ]; then
                        kubectl  patch pvc ${name} -p '{"metadata":{"finalizers":null}}'
                    else
                        echo "${name} did not meet age threshold (${hrs}hr)"
                    fi
                done <<< $pvc_to_del
            resources:
              requests:
                cpu: "200m"
                memory: "500M"
          restartPolicy: Never
          serviceAccountName: cron-buddy
      backoffLimit: 0
