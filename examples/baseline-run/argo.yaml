apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: baseline-run-
spec:
  entrypoint: baseline-run
  volumeClaimTemplates:
    - metadata:
        name: work-volume
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 100Gi
  volumes:
    - name: external-volume
      persistentVolumeClaim:
        claimName: nudging-read-only
        readOnly: true
    - name: gcp-key-secret
      secret:
        defaultMode: 420
        secretName: gcp-key
  templates:
    - name: baseline-run
      templateRef:
        name: prognostic-run
        template: prognostic-run
      inputs:
        parameters:
          - name: config
            value: |
              base_version: v0.5
              diagnostics:
                 - name: data.zarr
                   times:
                     frequency: 7200
                     kind: interval
                   variables:
                     - tendency_of_air_temperature_due_to_fv3_physics
                     - tendency_of_specific_humidity_due_to_fv3_physics
                     - air_temperature
                     - specific_humidity
                     - pressure_thickness_of_atmospheric_layer
                 - name: diags.zarr
                   times:
                     frequency: 900
                     kind: interval
                   variables:
                     - net_moistening
                     - net_moistening_diagnostic
                     - net_heating
                     - net_heating_diagnostic
                     - water_vapor_path
                     - physics_precip
              forcing: gs://vcm-fv3config/data/base_forcing/v1.1/
              orographic_forcing: gs://vcm-fv3config/data/orographic_data/v1.0
              diag_table: {{workflow.parameters.diag_table}}
              namelist:
                coupler_nml:
                  calendar: julian
                  days: 10
                  hours: 0
                  minutes: 0
                  months: 0
                  seconds: 0
                gfdl_cloud_microphysics_nml:
                  fast_sat_adj: false
                fv_core_nml:
                  do_sat_adj: false
                gfs_physics_nml:
                  ldiag3d: true
                  fhzero: 2.0
                atmos_model_nml:
                  fhout: 2.0
                  fhmax: 10000

          - name: output
            value: "{{workflow.parameters.output}}"
          - name: image-tag
            value: 10e9832e55119eec6a3d97dda542e45373d67683
          - name: initial-condition
            value: "20160801.001500"
          # dummy value not actually used
          - name: trained-ml
            value: gs://vcm-ml-scratch/test-end-to-end-integration/integration-test-3564a8369bbf/trained_model
          - name: store-true-args
            value: --diagnostic_ml
          - name: chunks
            value: |
              physics_output.zarr:
                time: 24
              physics_tendency_components.zarr:
                time: 1
              data.zarr:
                time: 1
              diags.zarr:
                time: 24
          - name: segment-count
            value: "4"
          # argo details
          - name: reference-restarts
            value: gs://vcm-ml-experiments/2020-06-02-fine-res/coarsen_restarts
          - name: cpu
            value: "6"
          - name: memory
            value: "6Gi"
          - name: work-volume-name
            value: work-volume
          - name: external-volume-name
            value: external-volume
